<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="https://gmpg.org/xfn/11">
<link rel="pingback" href="./../xmlrpc.php">


<title>Snort IDS Custom Dynamic Preprocessor, Part 1 &#8211; M43L57R0M</title>
<meta name="robots" content="max-image-preview:large">
<link rel="alternate" type="application/rss+xml" title="M43L57R0M &raquo; Feed" href="./../feed/index.html">
<link rel="alternate" type="application/rss+xml" title="M43L57R0M &raquo; Comments Feed" href="./../comments/feed/index.html">
<link rel="alternate" type="application/rss+xml" title="M43L57R0M &raquo; Snort IDS Custom Dynamic Preprocessor, Part 1 Comments Feed" href="./feed/index.html">
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":".\/\/wp-includes\/js\/wp-emoji-release.min.js?ver=d807bb9ef10808c7172aab675a714555"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"🏳️‍⚧️","🏳️​⚧️")?!1:!n(e,"🇺🇳","🇺​🇳")&&!n(e,"🏴󠁧󠁢󠁥󠁮󠁧󠁿","🏴​󠁧​󠁢​󠁥​󠁮​󠁧​󠁿");case"emoji":return!n(e,"🐦‍⬛","🐦​⬛")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="./../wp-includes/css/dist/block-library/style.min.css?ver=d807bb9ef10808c7172aab675a714555" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="coral-dark-style-css" href="./../wp-content/themes/coral-dark/style.css?ver=d807bb9ef10808c7172aab675a714555" type="text/css" media="all">
<style id="coral-dark-style-inline-css" type="text/css">h1, h2, h3, h4, h5, h6 { font-family: 'Lucida Console', Monaco, monospace;}
		h1.site-title, h3.site-title { font-family: 'Lucida Console', Monaco, monospace;}
		h2.site-description, h4.site-description { font-family: 'Lucida Console', Monaco, monospace;}
		
		body, button, input, select, textarea {	font-size: 14px;}
		h1.site-title, h3.site-title {
			margin-top: 25px; 
			font-size: 36px; 
		}
		h1.site-title a,
		h1.site-title a:visited,
		h1.site-title a:hover,
		h1.site-title a:active,
		h1.site-title a:focus,
		h3.site-title a,
		h3.site-title a:visited,
		h3.site-title a:hover,
		h3.site-title a:active,
		h3.site-title a:focus {
			color: #ffffff !important;
		}
		
		h2.site-description, h4.site-description {
			margin-top: -5px;
			font-size: 14px;
			color: #ffffff;
		}
		.custom-logo {max-height: 100px;}
		@media screen and (min-width: 768px) {
			.main-navigation {margin-top: 15px;}
			#search1 {margin-top: 42px;}
			#social1 {margin-top: 47px;}
		}</style>
<link rel="stylesheet" id="enlighterjs-css" href="./../wp-content/plugins/enlighter/cache/enlighterjs.min.css?ver=FEHentKvd4xOWg9" type="text/css" media="all">
<script type="text/javascript" src="./../wp-includes/js/jquery/jquery.min.js?ver=3.7.1" id="jquery-core-js"></script>
<script type="text/javascript" src="./../wp-includes/js/jquery/jquery-migrate.min.js?ver=3.4.1" id="jquery-migrate-js"></script>
<script type="text/javascript" src="./../wp-content/themes/coral-dark/js/jquery.nivo.slider.pack.js?ver=3.2" id="nivo-slider-js"></script>
<link rel="https://api.w.org/" href="./../wp-json/index.html">
<link rel="alternate" title="JSON" type="application/json" href="./../wp-json/wp/v2/posts/245/index.html">
<link rel="canonical" href="./index.html">
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="./../wp-json/oembed/1.0/embed/index.html?url=.%2F%2Fsnort-custom-dynamic-preprocessor%2F">
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="./../wp-json/oembed/1.0/embed/index.html?url=.%2F%2Fsnort-custom-dynamic-preprocessor%2F#038;format=xml">
<meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett">
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>		<style type="text/css" id="wp-custom-css">/*
You can add your own CSS here.

Click the help icon above to learn more.
*/</style>
		</head>

<body data-rsssl="1" class="post-template-default single single-post postid-245 single-format-standard wp-embed-responsive">
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<header id="masthead" class="site-header grid-container" role="banner">
		<div class="site-branding egrid  grid-35 tablet-grid-35 mobile-grid-100">
												<h3 class="site-title"><a href="./../index.html" rel="home">M43L57R0M</a></h3>
					<h4 class="site-description">Information Security, Software Engineering</h4>
					
							
		</div>
<!-- .site-branding -->
		<div id="headerright" class="grid-parent egrid  grid-65 tablet-grid-65 mobile-grid-100">
			
			<div id="social1" class="egrid  grid-60 tablet-grid-60 mobile-grid-100">
							</div>
			
			<div id="search1" class="search  grid-40 tablet-grid-40 mobile-grid-100">
				<div class="search-container">
<form role="search" method="get" class="search-form" action=".//">
	<fieldset>
		<input type="search" class="search-field" placeholder="Search..." value="" name="s" title="Search for:">
		<input type="submit" class="search-submit" value="">
	</fieldset>
</form>
</div>			</div>
		</div>

		<nav id="site-navigation" class="main-navigation egrid grid-100 tablet-grid-100 mobile-grid-100" role="navigation">
			<i id="menu-button" class="fa fa-bars collapsed"><span>  Menu</span></i>
					</nav><!-- #site-navigation -->
	</header><!-- #masthead -->

		
<!-- breadcrumbs from Yoast or NavXT plugins -->
		
	<div id="content" class="site-content grid-container">

	<div id="primary" class="content-area egrid  grid-80 tablet-grid-80 mobile-grid-100 push-20 tablet-push-20">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-245" class="post-245 post type-post status-publish format-standard has-post-thumbnail hentry category-ids category-network-reconnaissance category-siem tag-ids tag-network tag-plugin tag-siem tag-snort tag-splunk">
	<header class="entry-header">
		<h1 class="entry-title">Snort IDS Custom Dynamic Preprocessor, Part 1</h1>
		<div class="entry-meta">
			<span class="posted-on"><a href="./index.html" rel="bookmark"><time class="entry-date published" datetime="2017-08-08T11:49:43+01:00">August 8, 2017</time><time class="updated" datetime="2019-12-03T21:54:32+01:00">December 3, 2019</time></a></span><span class="byline"> <span class="author vcard"><a class="url fn n" href="./../author/admin/index.html">spen440</a></span></span>		</div>
<!-- .entry-meta -->
	</header><!-- .entry-header -->

	<div class="entry-content">
		
		
	<div class="post-thumbnail">
		<img width="650" height="436" src="./../wp-content/uploads/2017/08/intruder-e1502218738571.png" class="attachment-large size-large wp-post-image" alt="" decoding="async" fetchpriority="high" srcset="./../wp-content/uploads/2017/08/intruder-e1502218738571.png 650w, ./../wp-content/uploads/2017/08/intruder-e1502218738571-300x201.png 300w, ./../wp-content/uploads/2017/08/intruder-e1502218738571-210x141.png 210w" sizes="(max-width: 650px) 100vw, 650px"><div class="ccfic"><span class="ccfic-text"> A Constable of the Metropolitan Police Force performs intrusion detection and prevention, London 1864.</span></div>	</div>
<!-- .post-thumbnail -->

	<p>&nbsp;</p>
<h2>Introduction</h2>
<p>This post describes process of building a custom dynamic preprocessor plugin for the Snort Network Intrusion Detection / Prevention System (IDS / IPS).</p>
<p>Snort is rules-based IDS. Although Snort rules have a simple structure, the number and variety of options within the Snort rule syntax allows reasonably complex analysis of packets under inspection to be performed. This is fine for situations where the symptoms of the threat being defended against can be <span id="more-245"></span></p>
<p>encapsulated within single logical expression (for example: &#8220;if the packet under inspection uses the TCP protocol, comes from the external network, is directed towards a database server within the internal network, and has the characters &#8220;0x02&#8243; at an offset of 23 bytes within its payload, then drop the packet&#8221;). However, if more complex analysis is needed then a different approach is required.</p>
<h2>Preprocessors</h2>
<p>A Snort preprocessor is a type of plugin which can be used to contribute additional processing functional to the core engine. Dynamic preprocessors are self contained libraries written in C which can be compiled independently of the main code base. The library is then included by placing it in a directory where Snort can find it at start-up, and updating the Snort configuration file so that Snort is aware of it.</p>
<h2>Shellcode Detection</h2>
<p>In a <a href="./../win7-seh-buffer-overflow-exploit/index.html">previous post</a>, I demonstrated a technique for exploiting a known vulnerability within a commercially available chat server application. The exploit involves delivering a payload containing reverse TCP shellcode which is then used to gain control over the compromised host.</p>
<p>The ultimate aim of this exercise is to develop a dynamic preprocessor which will be capable of detecting the pattern of data within a packet payload which indicates that a buffer overflow attack is in progress. I plan to do this in two parts:</p>
<p>The first part (this post) will describe the end-to-end process of putting together a template for the preprocessor, building it, checking that it gets loaded by Snort at runtime and then verifying that we can cause it to generate alerts by sending malicious traffic across the network segment it is monitoring, and checking that these alerts are then fowarded to an SIEM for analysis.</p>
<p>The second part (yet to be written at this point in time) will focus on the implementation detail of the main processing function within the preprocessor. The aim is devise an algorithm which can detect the tell-tale signs of a buffer overflow attack, without relying rigidly on the details of any specific vulnerability or known attack strategy. By understanding the general anatomy of a buffer overflow attack, I hope it will be possible to make informed judgements about the meaning of data values within the payload by looking at them within the context of the whole payload, rather than just determing their absence or presence, as a rule does.  The approach taken by Stig Andersson, Andrew Clark, and George Mohay in their research paper &#8220;<a href="https://www.researchgate.net/publication/27478341_Network_based_buffer_overflow_detection_by_exploit_code_analysis">Network based buffer overflow detection by exploit code analysis</a>&#8221; looks interesting and may provide some useful ideas.</p>
<p>It&#8217;s quite possible to achieve the functionality I&#8217;ve implemented here in Part 1 just using a rule; the reason I&#8217;ve split the development into two parts is partly because I&#8217;m doing this over a period of a few weeks and I&#8217;m using this blog as a kind of incremental work journal, and partly because I think this structure might of more use to people who just want to know how to get a template dynamic preprocessor project up and running but have some other purpose in mind for it.</p>
<h2>Test Lab</h2>
<p>The test lab was put together with the help of <a href="https://twitter.com/da_667">Tony Robinson&#8217;s</a> excellent book &#8220;<a href="https://www.goodreads.com/book/show/35406833-building-virtual-machine-labs">Building Virtual Machine Labs: A Hands-On Guide</a>&#8220;. The network architecture is divided into a number of segments using the virtual networking facilities provided by VirtualBox&#8217;s VMs.  This allows the guest VMs to be segregated logically according to their respective functions within the test lab. This approach enforces security by filtering traffic through a VM which acts as a firewall and a network gateway (pfSense). In this manner, traffic between the virtual and local physical networks, and traffic between the IPS (Snort) VM and the SIEM (Splunk) VM and the Snort management interface host, can be monitored and controlled separately.</p>
<p>In this setup, Snort is configured to be in-line between two network segments using a pair of virtual network adapters, rather than simply monitoring traffic passively. As well as allowing Snort to act as an IPS (ie by dropping packets) if required, a major advantage of this arrangement is that it allows one segment of the lab to be configured as a secure sandbox for examining malware if required. Shutting down the IPS VM will effectively isolate the segment containing the compromised host, which is a very useful &#8220;panic button&#8221; facility to have available, should things get out of control.</p>
<figure id="attachment_297" aria-describedby="caption-attachment-297" style="width: 980px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/pwnlab-nw-diag-2.png"><img decoding="async" class="wp-image-297 size-large" src="./../wp-content/uploads/2017/08/pwnlab-nw-diag-2-1024x704.png" alt="" width="980" height="674" data-wp-pid="297" srcset="./../wp-content/uploads/2017/08/pwnlab-nw-diag-2-1024x704.png 1024w, ./../wp-content/uploads/2017/08/pwnlab-nw-diag-2-300x206.png 300w, ./../wp-content/uploads/2017/08/pwnlab-nw-diag-2-768x528.png 768w, ./../wp-content/uploads/2017/08/pwnlab-nw-diag-2-210x144.png 210w, ./../wp-content/uploads/2017/08/pwnlab-nw-diag-2.png 1076w" sizes="(max-width: 980px) 100vw, 980px"></a><figcaption id="caption-attachment-297" class="wp-caption-text">Virtualised Lab Architecture</figcaption></figure>
<p>&nbsp;</p>
<figure id="attachment_263" aria-describedby="caption-attachment-263" style="width: 980px" class="wp-caption alignnone"><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54.png"><img decoding="async" class="wp-image-263 size-large" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54-1024x576.png" alt="" width="980" height="551" data-wp-pid="263" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54-1024x576.png 1024w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54-300x169.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54-768x432.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54-210x118.png 210w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-54.png 1366w" sizes="(max-width: 980px) 100vw, 980px"></a><figcaption id="caption-attachment-263" class="wp-caption-text">Virtualised Test Lab &#8211; VirtualBox on CentOS 7</figcaption></figure>
<h2>DPX</h2>
<p>The nice people over at <a href="https://www.snort.org/">Snort headquarters</a> have made a example dynamic preprocessor  (<span style="text-decoration: underline;">D</span>ymanic <span style="text-decoration: underline;">P</span>reprocessor e<span style="text-decoration: underline;">X</span>ample) project available for <a href="https://www.snort.org/documents/38">download</a>. The project provides the source code for an &#8220;empty&#8221; plugin, build scripts which take care of bringing all the required elements together and distributing the ouput binaries to the correct locations, plus a unit test script (bundled with some test data in the form of a .pcap file) to verify that the resultant plugin behaves as it should &#8211; in isolation, at least.</p>
<p>Although this project is really helpful in providing a head-start, the business of getting the plugin configured, registered with and loaded by Snort at start-up and called during execution takes a little more work, and not all of the steps involved are entirely intuitive.  The remainder of this post explains how to get the preprocessor up and running in a test lab environment.</p>
<h2>Installation</h2>
<p>The steps involved in downloading, installing and building the example project as-is are listed <a href="https://www.snort.org/documents/38">here</a>. Note that the source development header files for Snort itself are also needed to allow the project to be built. These won&#8217;t be present in an existing Snort installation unless it was built from source and so need will need to be downloaded separately.</p>
<figure id="attachment_275" aria-describedby="caption-attachment-275" style="width: 810px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/build-log-2.png"><img loading="lazy" decoding="async" class="wp-image-275 size-full" src="./../wp-content/uploads/2017/08/build-log-2.png" alt="" width="810" height="744" data-wp-pid="275" srcset="./../wp-content/uploads/2017/08/build-log-2.png 810w, ./../wp-content/uploads/2017/08/build-log-2-300x276.png 300w, ./../wp-content/uploads/2017/08/build-log-2-768x705.png 768w, ./../wp-content/uploads/2017/08/build-log-2-210x193.png 210w" sizes="(max-width: 810px) 100vw, 810px"></a><figcaption id="caption-attachment-275" class="wp-caption-text">Building the example dynamic preprocessor.</figcaption></figure>
<h2>Hello World</h2>
<p>As I mentioned previously, the aim in Part 1 of this post is just to add some simple functionality to the preprocessor and prove that it&#8217;s working, before moving on to more complex packet payload analysis functionality in Part 2. The following paragraphs describe what I did to acheive that objective.</p>
<h3>Source Code Changes</h3>
<p>Out of the box, the example preprocessor examines packets to determine whether the source or destination port number matches a pre-defined number. This number is defined in Snort configuration file, which needs to be modified to incude configuration values for the new preprocessor. I modified the source to allow the preprocessor to look for the presence of a sequence of hex values within the packet payload. This sequence represents the opcodes &#8220;JMP 06 NOP NOP&#8221; typically seen when an <a href="./../win7-seh-buffer-overflow-exploit/index.html">exploit which abuses Windows SEH</a> is deployed.</p>
<p><strong>/opt/snort_dpx/dpx-1.7/dpx.c</strong></p>
<figure id="attachment_251" aria-describedby="caption-attachment-251" style="width: 845px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/dpx-c.png"><img loading="lazy" decoding="async" class="wp-image-251 size-full" src="./../wp-content/uploads/2017/08/dpx-c.png" alt="" width="845" height="335" data-wp-pid="251" srcset="./../wp-content/uploads/2017/08/dpx-c.png 845w, ./../wp-content/uploads/2017/08/dpx-c-300x119.png 300w, ./../wp-content/uploads/2017/08/dpx-c-768x304.png 768w, ./../wp-content/uploads/2017/08/dpx-c-210x83.png 210w" sizes="(max-width: 845px) 100vw, 845px"></a><figcaption id="caption-attachment-251" class="wp-caption-text">Addition of search string containing opcode hex values.</figcaption></figure>
<p><strong>/opt/snort_dpx/dpx-1.7/dpx.c</strong></p>
<figure id="attachment_250" aria-describedby="caption-attachment-250" style="width: 856px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/dpx-c-2.png"><img loading="lazy" decoding="async" class="wp-image-250 size-full" src="./../wp-content/uploads/2017/08/dpx-c-2.png" alt="" width="856" height="635" data-wp-pid="250" srcset="./../wp-content/uploads/2017/08/dpx-c-2.png 856w, ./../wp-content/uploads/2017/08/dpx-c-2-300x223.png 300w, ./../wp-content/uploads/2017/08/dpx-c-2-768x570.png 768w, ./../wp-content/uploads/2017/08/dpx-c-2-210x156.png 210w" sizes="(max-width: 856px) 100vw, 856px"></a><figcaption id="caption-attachment-250" class="wp-caption-text">Addition of a simple substring search to main preprocessor method.</figcaption></figure>
<p>Notice the call to DynamicPreprocessorData.alertAdd(&#8230;), which causes an alert to be generated when the required conditions are met. This method takes seven parameters: the ID of the preprocessor, the ID of the rule, the rule revision number, the alert classication number, the alert pritority, a message string and a reference to metadata pertinent to the alert (none in this case). NB: The use of term &#8220;rule&#8221; is used here even though we&#8217;re not dealing with a rule object; I suspect this is because alerts are <em>normally</em> generated by Snort rules, and the terminolgy used within the source probably isn&#8217;t generic enough to deal with alerts generated from other sources.</p>
<h3>Configuration Changes</h3>
<p>The alert classification number used in the above method call is derived from the alert classification file which maps classfication types to alert messages:</p>
<p><strong>/opt/snort/etc/classification.conf</strong></p>
<p><a href="./../wp-content/uploads/2017/08/classification-config.png"><img loading="lazy" decoding="async" class="alignnone size-medium_large wp-image-249" src="./../wp-content/uploads/2017/08/classification-config-768x186.png" alt="" width="768" height="186" data-wp-pid="249" srcset="./../wp-content/uploads/2017/08/classification-config-768x186.png 768w, ./../wp-content/uploads/2017/08/classification-config-300x73.png 300w, ./../wp-content/uploads/2017/08/classification-config-210x51.png 210w, ./../wp-content/uploads/2017/08/classification-config.png 938w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<p><strong>/opt/snort_dpx/dpx-1.7/dpx.c</strong></p>
<figure id="attachment_271" aria-describedby="caption-attachment-271" style="width: 845px" class="wp-caption alignnone"><a href="./../wp-content/uploads/2017/08/dpx-c-3.png"><img loading="lazy" decoding="async" class="wp-image-271 size-full" src="./../wp-content/uploads/2017/08/dpx-c-3.png" alt="" width="845" height="335" data-wp-pid="271" srcset="./../wp-content/uploads/2017/08/dpx-c-3.png 845w, ./../wp-content/uploads/2017/08/dpx-c-3-300x119.png 300w, ./../wp-content/uploads/2017/08/dpx-c-3-768x304.png 768w, ./../wp-content/uploads/2017/08/dpx-c-3-210x83.png 210w" sizes="(max-width: 845px) 100vw, 845px"></a><figcaption id="caption-attachment-271" class="wp-caption-text">GID and SID definitions</figcaption></figure>
<p>Constants defined in the preprocessor info header file sf_preproc_info.h determine the major and and minor version numbers, plus the name of the preprocessor (the name string value is important, as it is used to identify configuration values with the snort.conf config file):</p>
<p><strong>/opt/snort_dpx/dpx-1.7/sf_preproc_info.h</strong></p>
<figure id="attachment_270" aria-describedby="caption-attachment-270" style="width: 537px" class="wp-caption alignnone"><a href="./../wp-content/uploads/2017/08/sf_preproc_info-2.png"><img loading="lazy" decoding="async" class="wp-image-270" src="./../wp-content/uploads/2017/08/sf_preproc_info-2.png" alt="" width="537" height="179" data-wp-pid="270" srcset="./../wp-content/uploads/2017/08/sf_preproc_info-2.png 660w, ./../wp-content/uploads/2017/08/sf_preproc_info-2-300x100.png 300w, ./../wp-content/uploads/2017/08/sf_preproc_info-2-210x70.png 210w" sizes="(max-width: 537px) 100vw, 537px"></a><figcaption id="caption-attachment-270" class="wp-caption-text">Major/minor version numbers and preprocessor name definitions</figcaption></figure>
<p>Snort determines where to look for dynamic prepreocessors according to an entry in the snort.conf configuration file:</p>
<p><strong>/opt/snort/etc/snort.conf</strong></p>
<figure id="attachment_305" aria-describedby="caption-attachment-305" style="width: 980px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/snort-conf-1.png"><img loading="lazy" decoding="async" class="wp-image-305 size-large" src="./../wp-content/uploads/2017/08/snort-conf-1-1024x329.png" alt="" width="980" height="315" data-wp-pid="305" srcset="./../wp-content/uploads/2017/08/snort-conf-1-1024x329.png 1024w, ./../wp-content/uploads/2017/08/snort-conf-1-300x97.png 300w, ./../wp-content/uploads/2017/08/snort-conf-1-768x247.png 768w, ./../wp-content/uploads/2017/08/snort-conf-1-210x68.png 210w, ./../wp-content/uploads/2017/08/snort-conf-1.png 1147w" sizes="(max-width: 980px) 100vw, 980px"></a><figcaption id="caption-attachment-305" class="wp-caption-text">&#8220;dynamicpreprocessor directory&#8221; entry in snort.conf</figcaption></figure>
<p>To ensure that the new preprocessor is loaded dynamically by Snort, either copy or symlink the libraries to the location specified in &#8220;dynamicpreprocessor directory&#8221; entry in the snort.conf configuration file:</p>
<figure id="attachment_262" aria-describedby="caption-attachment-262" style="width: 802px" class="wp-caption alignright"><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37.png"><img loading="lazy" decoding="async" class="wp-image-262 size-full" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37.png" alt="" width="802" height="167" data-wp-pid="262" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37.png 802w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37-300x62.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37-768x160.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-30-37-210x44.png 210w" sizes="(max-width: 802px) 100vw, 802px"></a><figcaption id="caption-attachment-262" class="wp-caption-text">Libraries associated with the example dynamic preprocessor</figcaption></figure>
<p>Newer versions of Snort allows rules and events associated with preprocessors to be enabled and disabled individually via separate configuration file, however for the purposes of this exercise, we can just direct Snort to automatically enable all preprocessor rules with the following entry in the snort.conf configuration file:</p>
<p><strong>/opt/snort/etc/snort.conf</strong></p>
<p><a href="./../wp-content/uploads/2017/08/snort-conf-2.png"><img loading="lazy" decoding="async" class="size-large wp-image-306 aligncenter" src="./../wp-content/uploads/2017/08/snort-conf-2-1024x329.png" alt="" width="980" height="315" data-wp-pid="306" srcset="./../wp-content/uploads/2017/08/snort-conf-2-1024x329.png 1024w, ./../wp-content/uploads/2017/08/snort-conf-2-300x97.png 300w, ./../wp-content/uploads/2017/08/snort-conf-2-768x247.png 768w, ./../wp-content/uploads/2017/08/snort-conf-2-210x68.png 210w, ./../wp-content/uploads/2017/08/snort-conf-2.png 1147w" sizes="(max-width: 980px) 100vw, 980px"></a></p>
<p>While we&#8217;re modifying snort.conf, let&#8217;s add an entry to configure the preprocessor&#8217;s behaviour at runtime. The following line defines the value a port number; the packet being processed must have either a source or destination port value which matches this value or the packet will be ignored by the preprocessor:</p>
<p><strong>/opt/snort/etc/snort.conf</strong></p>
<p><a href="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42.png"><img loading="lazy" decoding="async" class="alignnone size-medium_large wp-image-255" src="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42-768x241.png" alt="" width="768" height="241" data-wp-pid="255" srcset="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42-768x241.png 768w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42-300x94.png 300w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42-1024x321.png 1024w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42-210x66.png 210w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.40.42.png 1083w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<p>To make debugging a little easier, let&#8217;s also ensure that Snort generates a vebose human-readable alert text file, as well as the standard unified binary format alert file:</p>
<p><a href="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14.png"><img loading="lazy" decoding="async" class="alignnone size-medium_large wp-image-256" src="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14-768x252.png" alt="" width="768" height="252" data-wp-pid="256" srcset="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14-768x252.png 768w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14-300x99.png 300w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14-210x69.png 210w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.42.14.png 810w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<p>The last step is to map the preprocessor GID and SID values to human-readable message strings which will be included in the generated alerts &#8211; this is achieved by adding entries to the gen-msg.map file:</p>
<p><strong>/opt/snort/etc/gen-msg.map</strong></p>
<p><a href="./../wp-content/uploads/2017/08/gen-msg-map.png"><img loading="lazy" decoding="async" class="alignnone size-full wp-image-252" src="./../wp-content/uploads/2017/08/gen-msg-map.png" alt="" width="949" height="166" data-wp-pid="252" srcset="./../wp-content/uploads/2017/08/gen-msg-map.png 949w, ./../wp-content/uploads/2017/08/gen-msg-map-300x52.png 300w, ./../wp-content/uploads/2017/08/gen-msg-map-768x134.png 768w, ./../wp-content/uploads/2017/08/gen-msg-map-210x37.png 210w" sizes="(max-width: 949px) 100vw, 949px"></a></p>
<h2>Testing</h2>
<p>Having made the required source code and config file changes, we can now rebuild the preprocessor and then restart Snort:</p>
<p><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59.png"><img loading="lazy" decoding="async" class="alignnone size-medium_large wp-image-261" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59-768x173.png" alt="" width="768" height="173" data-wp-pid="261" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59-768x173.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59-300x68.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59-210x47.png 210w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-25-59.png 797w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<p>Examining the syslog log file, we can see that Snort appears to have loaded without errors:</p>
<p><strong>/var/log/syslog</strong></p>
<p><a href="./../wp-content/uploads/2017/08/syslog-1.png"><img loading="lazy" decoding="async" class="alignnone size-full wp-image-281" src="./../wp-content/uploads/2017/08/syslog-1.png" alt="" width="825" height="309" data-wp-pid="281" srcset="./../wp-content/uploads/2017/08/syslog-1.png 825w, ./../wp-content/uploads/2017/08/syslog-1-300x112.png 300w, ./../wp-content/uploads/2017/08/syslog-1-768x288.png 768w, ./../wp-content/uploads/2017/08/syslog-1-210x79.png 210w" sizes="(max-width: 825px) 100vw, 825px"></a></p>
<p>&#8230;and has loaded the new dynamic preprocessor:</p>
<p><a href="./../wp-content/uploads/2017/08/syslog-2-2.png"><img loading="lazy" decoding="async" class="alignnone size-full wp-image-283" src="./../wp-content/uploads/2017/08/syslog-2-2.png" alt="" width="850" height="342" data-wp-pid="283" srcset="./../wp-content/uploads/2017/08/syslog-2-2.png 850w, ./../wp-content/uploads/2017/08/syslog-2-2-300x121.png 300w, ./../wp-content/uploads/2017/08/syslog-2-2-768x309.png 768w, ./../wp-content/uploads/2017/08/syslog-2-2-210x84.png 210w" sizes="(max-width: 850px) 100vw, 850px"></a></p>
<h3>Exploit</h3>
<p>To test the functionality of the preprocessor, we launch an attack against the target host whose payload contains the shellcode for a Windows SEH exploit:</p>
<h2><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44.png"><img loading="lazy" decoding="async" class="alignnone size-full wp-image-285" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44.png" alt="" width="850" height="360" data-wp-pid="285" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44.png 850w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44-300x127.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44-768x325.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-08-13-45-44-210x89.png 210w" sizes="(max-width: 850px) 100vw, 850px"></a></h2>
<h3>Detection and Alerting</h3>
<p>By examining the Snort alert log file, we can see that the preprocessor has detected the SEH exploit opcode hex values and has generated an alert:</p>
<p><strong>/var/log/snort/sjd_alert.full</strong></p>
<p><a href="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26.png"><img loading="lazy" decoding="async" class="alignnone size-medium_large wp-image-258" src="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26-768x289.png" alt="" width="768" height="289" data-wp-pid="258" srcset="./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26-768x289.png 768w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26-300x113.png 300w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26-210x79.png 210w, ./../wp-content/uploads/2017/08/Item-0-SnappyApp-Today-at-19.47.26.png 956w" sizes="(max-width: 768px) 100vw, 768px"></a></p>
<h3>SIEM</h3>
<p>The last step in the verifcation process is to check that the Splunk universal forwarder correctly parses the alert and forwards the details as JSON formatted data to the Splunk SIEM for analysis. By issuing a simple search for the string &#8220;DPX&#8221; in the Splunk reporting interface, we can see that the alert has been received by the SIEM:</p>
<figure id="attachment_260" aria-describedby="caption-attachment-260" style="width: 768px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58.png"><img loading="lazy" decoding="async" class="wp-image-260 size-medium_large" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58-768x432.png" alt="" width="768" height="432" data-wp-pid="260" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58-768x432.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58-300x169.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58-1024x576.png 1024w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58-210x118.png 210w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-20-58.png 1366w" sizes="(max-width: 768px) 100vw, 768px"></a><figcaption id="caption-attachment-260" class="wp-caption-text">Preprocessor alert ingested by Splunk SIEM</figcaption></figure>
<p>Expanding the alert JSON data shows that the alert contains the data we expect in each field:</p>
<figure id="attachment_259" aria-describedby="caption-attachment-259" style="width: 768px" class="wp-caption aligncenter"><a href="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30.png"><img loading="lazy" decoding="async" class="wp-image-259 size-medium_large" src="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30-768x432.png" alt="" width="768" height="432" data-wp-pid="259" srcset="./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30-768x432.png 768w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30-300x169.png 300w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30-1024x576.png 1024w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30-210x118.png 210w, ./../wp-content/uploads/2017/08/Screenshot-from-2017-08-07-18-17-30.png 1366w" sizes="(max-width: 768px) 100vw, 768px"></a><figcaption id="caption-attachment-259" class="wp-caption-text">Splunk SIEM displaying preprocessor alert detail</figcaption></figure>
<h2>Conclusions</h2>
<p>Getting the example dynamic preprocessor example up and running took quite a bit of detective work and trial and error, but given the amount of extra processing scope and flexibility that preprocessors provide, over and above that provided by rules alone, I believe the investment in time and effort will prove to be worthwhile.</p>
<p>Hopefully the information presented here will be of help to anyone in a similar position. It&#8217;s worth noting that the post archives over at <a href="http://seclists.org/snort/">seclists.org</a> are great source of information, as were some of the papers at the <a href="https://uk.sans.org/reading-room/whitepapers/tools/">SANS UK Reading Room</a> site.</p>
<p>In Part 2 of this post, I&#8217;ll be tackling the business of implementing the main processing method within the preprocessor, which will require devising an algorithm which can detect the tell-tale signs of a buffer overflow attack, without relying rigidly on the details of any specific vulnerability or known attack strategy.</p>
			</div>
<!-- .entry-content -->

	<footer class="entry-footer">
		<span class="update">Updated: <a href="./index.html" rel="bookmark"><time class="published updated" datetime="2019-12-03T21:54:32+01:00">December 3, 2019</time></a></span><br><span class="cat-links">Categories: <a href="./../category/ids/index.html" rel="category tag">IDS</a>, <a href="./../category/network-reconnaissance/index.html" rel="category tag">Network Reconnaissance</a>, <a href="./../category/siem/index.html" rel="category tag">SIEM</a></span><span class="tags-links">Tags: <a href="./../tag/ids/index.html" rel="tag">IDS</a>, <a href="./../tag/network/index.html" rel="tag">Network</a>, <a href="./../tag/plugin/index.html" rel="tag">Plugin</a>, <a href="./../tag/siem/index.html" rel="tag">SIEM</a>, <a href="./../tag/snort/index.html" rel="tag">Snort</a>, <a href="./../tag/splunk/index.html" rel="tag">Splunk</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->
						
	<nav class="navigation post-navigation" aria-label="Post navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links">
<div class="nav-previous"><a href="./../throwing-star-lan-tap/index.html" rel="prev">Previous post</a></div>
<div class="nav-next"><a href="./../cloud-hosted-honeypots-harvesting-attack-packet-captures/index.html" rel="next">Next post</a></div>
</div>
	</nav>
			
		
		</main><!-- #main -->
	</div>
<!-- #primary -->


<div id="secondary" class="widget-area egrid  grid-20 tablet-grid-20 mobile-grid-100 pull-80 tablet-pull-80" role="complementary">

		<aside id="recent-posts-2" class="widget widget_recent_entries">
		<h4 class="widget-title">Recent Posts</h4>
		<ul>
											<li>
					<a href="./../shift-left-azure-pipelines/index.html">Shifting Left On A Shoestring: Azure DevSecOps Pipelines</a>
									</li>
											<li>
					<a href="./../insecure-deserialisation/index.html">Software Vulnerabilities and Business Risk</a>
									</li>
											<li>
					<a href="./../cloud-hosted-honeypots-harvesting-attack-packet-captures/index.html">Cloud Hosted Honeypots: Harvesting Attack Packet Captures</a>
									</li>
											<li>
					<a href="./index.html" aria-current="page">Snort IDS Custom Dynamic Preprocessor, Part 1</a>
									</li>
											<li>
					<a href="./../throwing-star-lan-tap/index.html">Throwing Star LAN Tap</a>
									</li>
					</ul>

		</aside><aside id="recent-comments-2" class="widget widget_recent_comments"><h4 class="widget-title">Recent Comments</h4>
<ul id="recentcomments"></ul></aside><aside id="categories-2" class="widget widget_categories"><h4 class="widget-title">Categories</h4>
			<ul>
					<li class="cat-item cat-item-33">
<a href="./../category/application-security/index.html">Application Security</a>
</li>
	<li class="cat-item cat-item-37">
<a href="./../category/azure/index.html">Azure</a>
</li>
	<li class="cat-item cat-item-32">
<a href="./../category/business-risk/index.html">Business Risk</a>
</li>
	<li class="cat-item cat-item-40">
<a href="./../category/ci-cd/index.html">CI-CD</a>
</li>
	<li class="cat-item cat-item-55">
<a href="./../category/containers/index.html">Containers</a>
</li>
	<li class="cat-item cat-item-42">
<a href="./../category/dast/index.html">DAST</a>
</li>
	<li class="cat-item cat-item-38">
<a href="./../category/devsecops/index.html">DevSecOps</a>
</li>
	<li class="cat-item cat-item-44">
<a href="./../category/docker/index.html">Docker</a>
</li>
	<li class="cat-item cat-item-46">
<a href="./../category/eclipse/index.html">Eclipse</a>
</li>
	<li class="cat-item cat-item-50">
<a href="./../category/git/index.html">Git</a>
</li>
	<li class="cat-item cat-item-48">
<a href="./../category/h2-database/index.html">H2 Database</a>
</li>
	<li class="cat-item cat-item-26">
<a href="./../category/honeypot/index.html">Honeypot</a>
</li>
	<li class="cat-item cat-item-19">
<a href="./../category/ids/index.html">IDS</a>
</li>
	<li class="cat-item cat-item-34">
<a href="./../category/insecure-deserialisation/index.html">Insecure Deserialisation</a>
</li>
	<li class="cat-item cat-item-35">
<a href="./../category/java/index.html">Java</a>
</li>
	<li class="cat-item cat-item-49">
<a href="./../category/junit/index.html">JUnit</a>
</li>
	<li class="cat-item cat-item-36">
<a href="./../category/lateral-movement/index.html">Lateral Movement</a>
</li>
	<li class="cat-item cat-item-47">
<a href="./../category/maven/index.html">Maven</a>
</li>
	<li class="cat-item cat-item-17">
<a href="./../category/network-reconnaissance/index.html">Network Reconnaissance</a>
</li>
	<li class="cat-item cat-item-53">
<a href="./../category/owasp-zap/index.html">OWASP ZAP</a>
</li>
	<li class="cat-item cat-item-39">
<a href="./../category/pipeline/index.html">Pipeline</a>
</li>
	<li class="cat-item cat-item-41">
<a href="./../category/sast/index.html">SAST</a>
</li>
	<li class="cat-item cat-item-43">
<a href="./../category/sca/index.html">SCA</a>
</li>
	<li class="cat-item cat-item-52">
<a href="./../category/shiftleft/index.html">ShiftLeft</a>
</li>
	<li class="cat-item cat-item-23">
<a href="./../category/siem/index.html">SIEM</a>
</li>
	<li class="cat-item cat-item-51">
<a href="./../category/snyk/index.html">Snyk</a>
</li>
	<li class="cat-item cat-item-45">
<a href="./../category/spring-boot/index.html">Spring Boot</a>
</li>
	<li class="cat-item cat-item-54">
<a href="./../category/sql-injection/index.html">SQL Injection</a>
</li>
	<li class="cat-item cat-item-27">
<a href="./../category/threat-intelligence/index.html">Threat Intelligence</a>
</li>
	<li class="cat-item cat-item-31">
<a href="./../category/threat-modeling/index.html">Threat Modeling</a>
</li>
	<li class="cat-item cat-item-1">
<a href="./../category/uncategorized/index.html">Uncategorized</a>
</li>
	<li class="cat-item cat-item-6">
<a href="./../category/windows-exploits/index.html">Windows Exploits</a>
</li>
			</ul>

			</aside><aside id="tag_cloud-3" class="widget widget_tag_cloud"><h4 class="widget-title">Tags</h4>
<div class="tagcloud">
<a href="./../tag/buffer-overflow/index.html" class="tag-cloud-link tag-link-10 tag-link-position-1" style="font-size: 8pt;" aria-label="Buffer Overflow (1 item)">Buffer Overflow</a>
<a href="./../tag/ethernet/index.html" class="tag-cloud-link tag-link-13 tag-link-position-2" style="font-size: 8pt;" aria-label="Ethernet (1 item)">Ethernet</a>
<a href="./../tag/exploits/index.html" class="tag-cloud-link tag-link-8 tag-link-position-3" style="font-size: 8pt;" aria-label="Exploits (1 item)">Exploits</a>
<a href="./../tag/honeypot/index.html" class="tag-cloud-link tag-link-28 tag-link-position-4" style="font-size: 8pt;" aria-label="Honeypot (1 item)">Honeypot</a>
<a href="./../tag/ids/index.html" class="tag-cloud-link tag-link-20 tag-link-position-5" style="font-size: 8pt;" aria-label="IDS (1 item)">IDS</a>
<a href="./../tag/kali/index.html" class="tag-cloud-link tag-link-11 tag-link-position-6" style="font-size: 8pt;" aria-label="Kali (1 item)">Kali</a>
<a href="./../tag/metasploit/index.html" class="tag-cloud-link tag-link-12 tag-link-position-7" style="font-size: 8pt;" aria-label="Metasploit (1 item)">Metasploit</a>
<a href="./../tag/mhn/index.html" class="tag-cloud-link tag-link-29 tag-link-position-8" style="font-size: 8pt;" aria-label="MHN (1 item)">MHN</a>
<a href="./../tag/network/index.html" class="tag-cloud-link tag-link-14 tag-link-position-9" style="font-size: 22pt;" aria-label="Network (2 items)">Network</a>
<a href="./../tag/packet-capture/index.html" class="tag-cloud-link tag-link-16 tag-link-position-10" style="font-size: 22pt;" aria-label="Packet Capture (2 items)">Packet Capture</a>
<a href="./../tag/plugin/index.html" class="tag-cloud-link tag-link-22 tag-link-position-11" style="font-size: 8pt;" aria-label="Plugin (1 item)">Plugin</a>
<a href="./../tag/seh/index.html" class="tag-cloud-link tag-link-9 tag-link-position-12" style="font-size: 8pt;" aria-label="SEH (1 item)">SEH</a>
<a href="./../tag/siem/index.html" class="tag-cloud-link tag-link-24 tag-link-position-13" style="font-size: 8pt;" aria-label="SIEM (1 item)">SIEM</a>
<a href="./../tag/snort/index.html" class="tag-cloud-link tag-link-21 tag-link-position-14" style="font-size: 8pt;" aria-label="Snort (1 item)">Snort</a>
<a href="./../tag/splunk/index.html" class="tag-cloud-link tag-link-25 tag-link-position-15" style="font-size: 8pt;" aria-label="Splunk (1 item)">Splunk</a>
<a href="./../tag/threat-intelligence/index.html" class="tag-cloud-link tag-link-30 tag-link-position-16" style="font-size: 8pt;" aria-label="Threat Intelligence (1 item)">Threat Intelligence</a>
<a href="./../tag/windows/index.html" class="tag-cloud-link tag-link-7 tag-link-position-17" style="font-size: 8pt;" aria-label="Windows (1 item)">Windows</a>
<a href="./../tag/wireshark/index.html" class="tag-cloud-link tag-link-18 tag-link-position-18" style="font-size: 22pt;" aria-label="Wireshark (2 items)">Wireshark</a>
</div>
</aside>
</div>
<!-- #secondary -->

	</div>
<!-- #content -->

	<footer id="colophon" class="site-footer grid-container" role="contentinfo">
		<div class="grid-100 tablet-grid-100 mobile-grid-100"><div class="sepline2"></div></div>
		<div class="egrid  grid-70 tablet-grid-70 mobile-grid-100" id="footer-widget-copyright">
					</div>
		<div class=" grid-30 tablet-grid-30 mobile-grid-100">
			<a id="designer" class="alignright" href="https://www.coralthemes.com/product/coral-dark-wordpress-theme/">Free dark wordpress theme</a>
		</div>
		
	</footer><!-- #colophon -->
</div>
<!-- #page -->

<script type="text/javascript" src="./../wp-content/themes/coral-dark/js/jquery.smartmenus.min.js?ver=0.9.7" id="smartmenus-js"></script>
<script type="text/javascript" src="./../wp-content/themes/coral-dark/js/skip-link-focus-fix.js?ver=20130115" id="coral-dark-skip-link-focus-fix-js"></script>
<script type="text/javascript" id="coral-dark-script-js-extra">
/* <![CDATA[ */
var nivoSliderParams = {"effect":"fade","animspeed":"500","pausetime":"5000"};
/* ]]> */
</script>
<script type="text/javascript" src="./../wp-content/themes/coral-dark/js/functions.js?ver=20160427" id="coral-dark-script-js"></script>
<script type="text/javascript" src="./../wp-content/plugins/enlighter/cache/enlighterjs.min.js?ver=FEHentKvd4xOWg9" id="enlighterjs-js"></script>
<script type="text/javascript" id="enlighterjs-js-after">
/* <![CDATA[ */
!function(e,n){if("undefined"!=typeof EnlighterJS){var o={"selectors":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"options":{"indent":4,"ampersandCleanup":true,"linehover":true,"rawcodeDbclick":false,"textOverflow":"break","linenumbers":false,"theme":"monokai","language":"python","retainCssClasses":false,"collapse":false,"toolbarOuter":"","toolbarTop":"{BTN_RAW}{BTN_COPY}{BTN_WINDOW}{BTN_WEBSITE}","toolbarBottom":""}};(e.EnlighterJSINIT=function(){EnlighterJS.init(o.selectors.block,o.selectors.inline,o.options)})()}else{(n&&(n.error||n.log)||function(){})("Error: EnlighterJS resources not loaded yet!")}}(window,console);
/* ]]> */
</script>

</body>
</html>